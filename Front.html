<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫—Ç–∏–≤–∏—Å—Ç—ã –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: #667eea;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .events-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .event-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .event-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .event-author {
            font-weight: bold;
            color: #667eea;
        }

        .event-date {
            font-size: 12px;
            color: #999;
        }

        .event-image {
            width: 100%;
            max-height: 500px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .event-content {
            padding: 20px;
        }

        .event-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .event-text {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .event-text.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .show-more-btn {
            color: #667eea;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin-bottom: 15px;
        }

        .show-more-btn:hover {
            text-decoration: underline;
        }

        .event-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #f0f0f0;
        }

        .like-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .like-btn:hover {
            transform: scale(1.1);
        }

        .like-btn.liked {
            color: #ef4444;
        }

        .error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 5px;
        }

        .success {
            color: #10b981;
            font-size: 12px;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        .profile-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .role-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #667eea;
            color: white;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .admin-badge {
            background: #f59e0b;
        }

        .superadmin-badge {
            background: #ef4444;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            color: #999;
        }

        .create-event-section {
            margin-bottom: 20px;
        }

        .user-card {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .user-card-info {
            flex: 1;
        }

        .user-card-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .user-card-email {
            color: #666;
            font-size: 14px;
        }

        .user-card-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .user-card-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-grant {
            background: #10b981;
            color: white;
        }

        .btn-grant:hover {
            background: #059669;
        }

        .btn-revoke {
            background: #f59e0b;
            color: white;
        }

        .btn-revoke:hover {
            background: #d97706;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 20px;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üéì –ê–∫—Ç–∏–≤–∏—Å—Ç—ã –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞</h1>
            </div>
            <div class="user-info">
                <div id="authSection">
                    <button class="btn btn-primary" onclick="showLoginModal()">–í–æ–π—Ç–∏</button>
                </div>
                <div id="userSection" class="hidden">
                    <span id="userName"></span>
                    <button class="btn btn-secondary" onclick="showProfile()">–ü—Ä–æ—Ñ–∏–ª—å</button>
                    <button class="btn btn-secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </header>

        <!-- Profile Section -->
        <div id="profileSection" class="profile-section hidden">
            <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="profileInfo"></div>
            <button class="btn btn-secondary" onclick="hideProfile()">–°–∫—Ä—ã—Ç—å</button>
        </div>

        <!-- Admin Panel (for admins) -->
        <div id="adminPanel" class="create-event-section hidden">
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="showCreateEventModal()">+ –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
            <button class="btn btn-secondary" style="width: 100%;" onclick="showUsersModal()">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>
        </div>

        <!-- Events Section -->
        <div id="eventsSection">
            <div class="loading" id="loadingEvents">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>
            <div class="events-list" id="eventsList"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <div id="loginError" class="error"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                    <button type="button" class="btn btn-secondary" onclick="closeLoginModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
            <hr style="margin: 20px 0;">
            <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="showRegisterModal()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label>–ò–º—è (–º–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤)</label>
                    <input type="text" id="registerName" required minlength="5">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <div id="registerError" class="error"></div>
                <div id="registerSuccess" class="success"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <button type="button" class="btn btn-secondary" onclick="closeRegisterModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div id="createEventModal" class="modal">
        <div class="modal-content">
            <h2>–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</h2>
            <form id="createEventForm">
                <div class="form-group">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="eventTitle" required>
                </div>
                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="eventText" required></textarea>
                </div>
                <div class="form-group">
                    <label>URL —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="url" id="eventPhoto">
                </div>
                <div id="createEventError" class="error"></div>
                <div id="createEventSuccess" class="success"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateEventModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Users Management Modal -->
    <div id="usersModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            <div class="loading" id="loadingUsers" style="color: #333;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="usersListContainer" style="max-height: 500px; overflow-y: auto;"></div>
            <button type="button" class="btn btn-secondary" style="margin-top: 20px;" onclick="closeUsersModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:8000'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL API
        let currentUser = null;
        let accessToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadEvents();
            
            // Setup forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('createEventForm').addEventListener('submit', handleCreateEvent);
        });

        // Auth Functions
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);
                
                const response = await fetch(`${API_BASE}/login/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                }

                const data = await response.json();
                accessToken = data.access_token;
                localStorage.setItem('accessToken', accessToken);
                
                await loadCurrentUser();
                closeLoginModal();
                document.getElementById('loginError').textContent = '';
                document.getElementById('loginForm').reset();
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/user/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        hashed_password: password
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                }

                document.getElementById('registerSuccess').textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.';
                document.getElementById('registerError').textContent = '';
                document.getElementById('registerForm').reset();
                
                setTimeout(() => {
                    closeRegisterModal();
                    showLoginModal();
                }, 2000);
            } catch (error) {
                document.getElementById('registerError').textContent = error.message;
                document.getElementById('registerSuccess').textContent = '';
            }
        }

        async function loadCurrentUser() {
            try {
                const response = await fetch(`${API_BASE}/login/test_auth`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                }

                const data = await response.json();
                currentUser = data.current_user;
                updateUIForUser();
            } catch (error) {
                logout();
            }
        }

        function checkAuth() {
            accessToken = localStorage.getItem('accessToken');
            if (accessToken) {
                loadCurrentUser();
            }
        }

        function updateUIForUser() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            
            // Show create event button for admins
            const isAdmin = currentUser.roles.includes('ROLE_PORTAL_ADMIN') || 
                          currentUser.roles.includes('ROLE_PORTAL_SUPERADMIN');
            
            if (isAdmin) {
                document.getElementById('adminPanel').classList.remove('hidden');
            }
        }

        function logout() {
            accessToken = null;
            currentUser = null;
            localStorage.removeItem('accessToken');
            
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            
            loadEvents(); // Reload events without auth
        }

        // Profile Functions
        function showProfile() {
            const profileInfo = document.getElementById('profileInfo');
            const roles = currentUser.roles.map(role => {
                let badgeClass = 'role-badge';
                let roleName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                if (role === 'ROLE_PORTAL_ADMIN') {
                    badgeClass += ' admin-badge';
                    roleName = '–ê–¥–º–∏–Ω';
                } else if (role === 'ROLE_PORTAL_SUPERADMIN') {
                    badgeClass += ' superadmin-badge';
                    roleName = '–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω';
                }
                
                return `<span class="${badgeClass}">${roleName}</span>`;
            }).join('');
            
            const isSuperAdmin = currentUser.roles.includes('ROLE_PORTAL_SUPERADMIN');
            
            profileInfo.innerHTML = `
                <p><strong>ID:</strong> ${currentUser.user_id}</p>
                <p><strong>–ò–º—è:</strong> ${currentUser.name}</p>
                <p><strong>Email:</strong> ${currentUser.email}</p>
                <p><strong>–†–æ–ª–∏:</strong> ${roles}</p>
                <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> ${new Date(currentUser.created_at).toLocaleDateString('ru-RU')}</p>
                ${!isSuperAdmin ? '<button class="btn btn-danger" style="margin-top: 15px;" onclick="deleteMyAccount()">–£–¥–∞–ª–∏—Ç—å –º–æ–π –∞–∫–∫–∞—É–Ω—Ç</button>' : ''}
            `;
            
            document.getElementById('profileSection').classList.remove('hidden');
        }

        function hideProfile() {
            document.getElementById('profileSection').classList.add('hidden');
        }

        // Events Functions
        async function loadEvents() {
            try {
                document.getElementById('loadingEvents').style.display = 'block';
                const response = await fetch(`${API_BASE}/event/`);
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π');
                }

                const events = await response.json();
                document.getElementById('loadingEvents').style.display = 'none';
                displayEvents(events);
            } catch (error) {
                document.getElementById('loadingEvents').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π';
                console.error(error);
            }
        }

        function displayEvents(events) {
            const list = document.getElementById('eventsList');
            
            if (events.length === 0) {
                list.innerHTML = '<div class="empty-state"><h3>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π</h3><p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Å–æ–±—ã—Ç–∏–µ!</p></div>';
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            events.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            list.innerHTML = events.map(event => {
                const isAdmin = currentUser && (
                    currentUser.roles.includes('ROLE_PORTAL_ADMIN') || 
                    currentUser.roles.includes('ROLE_PORTAL_SUPERADMIN')
                );
                
                const textLength = event.text.length;
                const needsExpand = textLength > 150;
                
                return `
                    <div class="event-card">
                        <div class="event-header">
                            <div>
                                <div class="event-author">–ê–≤—Ç–æ—Ä: ${event.author_id}</div>
                                <div class="event-date">${new Date(event.created_at).toLocaleDateString('ru-RU', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}</div>
                            </div>
                            ${isAdmin ? `<button class="btn btn-danger" onclick="deleteEvent('${event.event_id}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                        </div>
                        ${event.photo ? `<img src="${event.photo}" class="event-image" alt="${event.title}" onerror="this.style.display='none'">` : ''}
                        <div class="event-content">
                            <div class="event-title">${event.title}</div>
                            <div class="event-text ${needsExpand ? 'collapsed' : ''}" id="text-${event.event_id}">${event.text}</div>
                            ${needsExpand ? `<button class="show-more-btn" onclick="toggleText('${event.event_id}')">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é...</button>` : ''}
                        </div>
                        <div class="event-actions">
                            <button class="like-btn" onclick="likeEvent('${event.event_id}')" id="like-btn-${event.event_id}">
                                ‚ù§Ô∏è <span id="likes-${event.event_id}">${event.likes}</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleText(eventId) {
            const textElement = document.getElementById(`text-${eventId}`);
            const btn = event.target;
            
            if (textElement.classList.contains('collapsed')) {
                textElement.classList.remove('collapsed');
                btn.textContent = '–°–∫—Ä—ã—Ç—å';
            } else {
                textElement.classList.add('collapsed');
                btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é...';
            }
        }

        async function handleCreateEvent(e) {
            e.preventDefault();
            
            if (!currentUser) {
                document.getElementById('createEventError').textContent = '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
                return;
            }
            
            const title = document.getElementById('eventTitle').value;
            const text = document.getElementById('eventText').value;
            const photo = document.getElementById('eventPhoto').value || null;
            
            try {
                const response = await fetch(`${API_BASE}/event/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        title: title,
                        text: text,
                        author_id: currentUser.user_id,
                        photo: photo
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
                }

                document.getElementById('createEventSuccess').textContent = '–°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!';
                document.getElementById('createEventError').textContent = '';
                document.getElementById('createEventForm').reset();
                
                setTimeout(() => {
                    closeCreateEventModal();
                    loadEvents();
                }, 1500);
            } catch (error) {
                document.getElementById('createEventError').textContent = error.message;
                document.getElementById('createEventSuccess').textContent = '';
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/event/?event_id=${eventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
                }

                loadEvents();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: ' + error.message);
            }
        }

        function likeEvent(eventId) {
            // –≠—Ç–æ –¥–µ–º–æ-—Ñ—É–Ω–∫—Ü–∏—è, –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ª–∞–π–∫–æ–≤
            const likesElement = document.getElementById(`likes-${eventId}`);
            const likeBtn = document.getElementById(`like-btn-${eventId}`);
            const currentLikes = parseInt(likesElement.textContent);
            
            if (likeBtn.classList.contains('liked')) {
                likeBtn.classList.remove('liked');
                likesElement.textContent = currentLikes - 1;
            } else {
                likeBtn.classList.add('liked');
                likesElement.textContent = currentLikes + 1;
            }
        }

        // Modal Functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
        }

        function showRegisterModal() {
            closeLoginModal();
            document.getElementById('registerModal').classList.add('active');
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
            document.getElementById('registerSuccess').textContent = '';
        }

        function showCreateEventModal() {
            document.getElementById('createEventModal').classList.add('active');
        }

        function closeCreateEventModal() {
            document.getElementById('createEventModal').classList.remove('active');
            document.getElementById('createEventSuccess').textContent = '';
        }

        // Users Management Functions
        async function showUsersModal() {
            document.getElementById('usersModal').classList.add('active');
            document.getElementById('loadingUsers').style.display = 'block';
            document.getElementById('usersListContainer').innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/user/users`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                }

                const users = await response.json();
                document.getElementById('loadingUsers').style.display = 'none';
                displayUsers(users);
            } catch (error) {
                document.getElementById('loadingUsers').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('usersListContainer');
            
            if (users.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            const isSuperAdmin = currentUser.roles.includes('ROLE_PORTAL_SUPERADMIN');
            const isAdmin = currentUser.roles.includes('ROLE_PORTAL_ADMIN');
            
            container.innerHTML = users.map(user => {
                const userIsAdmin = user.roles.includes('ROLE_PORTAL_ADMIN');
                const userIsSuperAdmin = user.roles.includes('ROLE_PORTAL_SUPERADMIN');
                const isCurrentUser = user.user_id === currentUser.user_id;
                
                const roles = user.roles.map(role => {
                    let badgeClass = 'role-badge';
                    let roleName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    
                    if (role === 'ROLE_PORTAL_ADMIN') {
                        badgeClass += ' admin-badge';
                        roleName = '–ê–¥–º–∏–Ω';
                    } else if (role === 'ROLE_PORTAL_SUPERADMIN') {
                        badgeClass += ' superadmin-badge';
                        roleName = '–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω';
                    }
                    
                    return `<span class="${badgeClass}">${roleName}</span>`;
                }).join('');
                
                let actions = '';
                
                if (!isCurrentUser) {
                    // –¢–æ–ª—å–∫–æ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏
                    if (isSuperAdmin && !userIsSuperAdmin) {
                        if (userIsAdmin) {
                            actions += `<button class="btn btn-revoke" onclick="revokeAdminPrivilege('${user.user_id}')">–ó–∞–±—Ä–∞—Ç—å –∞–¥–º–∏–Ω–∞</button>`;
                        } else {
                            actions += `<button class="btn btn-grant" onclick="grantAdminPrivilege('${user.user_id}')">–í—ã–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞</button>`;
                        }
                    }
                    
                    // –ê–¥–º–∏–Ω—ã –∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –ª—é–±—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫—Ä–æ–º–µ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤)
                    if ((isAdmin || isSuperAdmin) && !userIsSuperAdmin) {
                        actions += `<button class="btn btn-danger" onclick="deleteUser('${user.user_id}')">–£–¥–∞–ª–∏—Ç—å</button>`;
                    }
                }
                
                return `
                    <div class="user-card">
                        <div class="user-card-header">
                            <div class="user-card-info">
                                <div class="user-card-name">${user.name} ${isCurrentUser ? '(–í—ã)' : ''}</div>
                                <div class="user-card-email">${user.email}</div>
                                <div style="margin-top: 5px;">${roles}</div>
                            </div>
                            <div class="user-card-actions">
                                ${actions}
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #999;">
                            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${new Date(user.created_at).toLocaleDateString('ru-RU')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function grantAdminPrivilege(userId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user/admin_privilege_grant?user_id=${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –ø—Ä–∞–≤');
                }

                alert('–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω—ã!');
                showUsersModal(); // Reload users list
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function revokeAdminPrivilege(userId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user/admin_privilege_revoke?user_id=${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –æ—Ç–∑—ã–≤–∞ –ø—Ä–∞–≤');
                }

                alert('–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–∞–Ω—ã!');
                showUsersModal(); // Reload users list
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user/?user_id=${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }

                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                showUsersModal(); // Reload users list
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function closeUsersModal() {
            document.getElementById('usersModal').classList.remove('active');
        }

        async function deleteMyAccount() {
            const confirmText = prompt('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!\n\n–ù–∞–ø–∏—à–∏—Ç–µ "–£–î–ê–õ–ò–¢–¨" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:');
            
            if (confirmText !== '–£–î–ê–õ–ò–¢–¨') {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user/?user_id=${currentUser.user_id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞');
                }

                alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                logout();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
    </script>
</body>
</html>